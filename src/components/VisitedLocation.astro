---
import { Image } from 'astro:assets';
import allVisits from '../data/visits.json';
import locations from '../data/locations.json';

interface Visit {
  name: string;
  dateVisited: string;
  herbs: number;
  aroma: number;
  flavor: number;
  noodles: number;
  meat: number;
  price: number;
  notes: string;
  googleRating: number;
  category: string;
}

interface Props {
  locationId: string;
  name: string;
  link: string;
  visits: Visit[];
}

const { locationId, name, link, visits } = Astro.props;

// Visits are already sorted in reverse chronological order (most recent first)
const mostRecentVisit = visits[0];
const lastVisited = new Date(mostRecentVisit.dateVisited).toLocaleDateString('en-us', {
  day: 'numeric',
  year: 'numeric',
  month: 'short',
});

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/images/*.{jpeg,jpg,png,gif,webp}'
);

// Create a chronological copy (oldest first) to determine visit numbers
// Image numbers correspond to chronological order (first visit = v1, second = v2, etc.)
const chronologicalVisits = [...visits].sort((a, b) => {
  const dateA = new Date(a.dateVisited).getTime();
  const dateB = new Date(b.dateVisited).getTime();
  return dateA - dateB; // Ascending order (oldest first)
});

// Create a map from visit date to visit number (chronological)
const visitNumberMap = new Map<string, number>();
chronologicalVisits.forEach((visit, index) => {
  visitNumberMap.set(visit.dateVisited, index + 1); // Visit numbers start at 1
});

// Prepare data for graphs (chronological order)
const graphData = chronologicalVisits.map(visit => ({
  date: new Date(visit.dateVisited).toLocaleDateString('en-us', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
  }),
  totalRating: visit.herbs + visit.aroma + visit.flavor + visit.noodles + visit.meat,
  price: visit.price,
}));

// Calculate average rating across all visits
const allVisitsArray = allVisits as Visit[];
const averageRating = allVisitsArray.reduce((sum, visit) => {
  return sum + visit.herbs + visit.aroma + visit.flavor + visit.noodles + visit.meat;
}, 0) / allVisitsArray.length;

// Calculate minimum rating across all visits
const minRating = Math.min(...allVisitsArray.map(visit => 
  visit.herbs + visit.aroma + visit.flavor + visit.noodles + visit.meat
));

// Calculate average price from most recent visit per location
const locationNames = (locations as Array<{ name: string }>).map(loc => loc.name);
const mostRecentVisitsByLocation = locationNames.map(locationName => {
  const locationVisits = allVisitsArray
    .filter(v => v.name === locationName)
    .sort((a, b) => {
      const dateA = new Date(a.dateVisited).getTime();
      const dateB = new Date(b.dateVisited).getTime();
      return dateB - dateA; // Most recent first
    });
  return locationVisits.length > 0 ? locationVisits[0] : null;
}).filter(visit => visit !== null) as Visit[];

const averagePrice = mostRecentVisitsByLocation.reduce((sum, visit) => {
  return sum + visit.price;
}, 0) / mostRecentVisitsByLocation.length;

// Helper function to find image for a specific visit number
function findImageForVisit(locationId: string, type: 'A' | 'B', visitNumber: number, images: Record<string, () => Promise<{ default: ImageMetadata }>>): string | null {
  const imagePath = `/src/images/${locationId}${type}v${visitNumber}.webp`;
  return imagePath in images ? imagePath : null;
}
---

<article class="location-page">
  <header>
    <h1>{name}</h1>
    <p class="map-link"><a href={link} target="_blank" rel="noopener noreferrer">View on Map <span class="external-link-arrow">â†—</span></a></p>
  </header>

  {visits.length >= 2 && (
    <section class="graphs-section">
      <div class="graph-container">
        <h2>Total Rating</h2>
        <canvas id="ratingChart"></canvas>
      </div>
      <div class="graph-container">
        <h2>Price</h2>
        <canvas id="priceChart"></canvas>
      </div>
    </section>
    <p>The graphs show the trend of the total rating and price for this restaurant over time. The dashed lines represent the average rating of all visits to all restaurants and the average price amongst all locations based on their most recent visit only.</p>
  )}

  {visits.map((visit) => {
    // Get the chronological visit number for this visit
    const visitNumber = visitNumberMap.get(visit.dateVisited) || 1;
    const visitDate = new Date(visit.dateVisited).toLocaleDateString('en-us', {
      day: 'numeric',
      year: 'numeric',
      month: 'short',
    });
    
    const phoImage = findImageForVisit(locationId, 'A', visitNumber, images);
    const herbsImage = findImageForVisit(locationId, 'B', visitNumber, images);
    const hasPhoImage = phoImage !== null;
    const hasHerbsImage = herbsImage !== null;

    return (
      <section class="visit-section">
        <h2 class="visit-date">{visitDate}</h2>
        
        {(hasPhoImage || hasHerbsImage) && (
          <div class="images">
            {hasPhoImage && phoImage && (
              <Image
                src={images[phoImage]()}
                alt="A bowl of Vietnamese beef noodle soup"
                width="375"
                height="375"
              />
            )}
            {hasHerbsImage && herbsImage && (
              <Image
                src={images[herbsImage]()}
                alt="A plate of herbs used to top beef noodle soup"
                width="375"
                height="375"
              />
            )}
          </div>
        )}
        <div class="stats">
          <div class={`stat-grid ${visits.length < 2 ? 'single-stat' : ''}`}>
            <div class="stat-item">
              <span class="stat-label">Price</span>
              <span class="stat-value">${visit.price}</span>
            </div>
            {visits.length >= 2 && (
              <>
                <div class="stat-item">
                  <span class="stat-label">Herbs</span>
                  <span class="stat-value">{visit.herbs}/5</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Aroma</span>
                  <span class="stat-value">{visit.aroma}/5</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Flavor</span>
                  <span class="stat-value">{visit.flavor}/5</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Noodles</span>
                  <span class="stat-value">{visit.noodles}/5</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Meat</span>
                  <span class="stat-value">{visit.meat}/5</span>
                </div>
                <div class="stat-item total-score">
                  <span class="stat-label">Total</span>
                  <span class="stat-value">{visit.herbs + visit.aroma + visit.flavor + visit.noodles + visit.meat}/25</span>
                </div>
              </>
            )}
          </div>
        </div>

        <div class="notes">
          <h3>Notes</h3>
          <p>{visit.notes}</p>
        </div>
      </section>
    );
  })}
</article>

<style>
  .location-page {
    padding: 2rem 0;
  }

  header {
    margin-bottom: 2rem;
  }

  header h1 {
    margin: 0;
    font-size: 2.5rem;
  }

  header a {
    text-decoration: none;
    color: inherit;
  }

  header a:hover {
    text-decoration: underline;
  }

  .map-link {
    margin: 0;
    font-weight: 600;
  }

  .external-link-arrow {
    display: inline-block;
    margin-left: 0.25rem;
    font-size: 0.9em;
    vertical-align: baseline;
  }

  .visit-section {
    padding-top: 1rem;
    border-top: 2px solid var(--light-pink);
  }

  .visit-section:first-of-type {
    border-top: none;
    padding-top: 0;
    margin-top: 0;
  }

  .visit-date {
    margin: 0 0 1.5rem 0;
    font-size: 1.75rem;
    color: var(--black);
  }

  .images {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin: 2rem 0;
    justify-items: center;
  }

  .images img {
    border-radius: 1rem;
    max-width: 100%;
    height: auto;
    box-shadow: var(--medium-shadow);
  }

  .stats {
    margin: 2rem 0;
  }

  .stats h3 {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
  }

  .stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
  }

  .stat-grid.single-stat {
    grid-template-columns: minmax(150px, max-content);
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem;
    background-color: var(--white);
    border-radius: 0.5rem;
    box-shadow: var(--low-shadow);
  }

  .stat-label {
    font-weight: 600;
  }

  .stat-value {
    color: var(--dark-pink);
    font-weight: 600;
  }

  .total-score {
    background-color: var(--light-pink);
    font-weight: 700;
  }

  .total-score .stat-value {
    font-size: 1.1em;
  }

  .notes {
    margin: 2rem 0;
  }

  .notes h3 {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
  }

  .graphs-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .graph-container {
    background-color: var(--white);
    padding: 1.5rem;
    border-radius: 0.5rem;
    box-shadow: var(--low-shadow);
  }

  .graph-container h2 {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
    color: var(--black);
  }

  .graph-container canvas {
    max-width: 100%;
    height: auto;
  }

  @media (max-width: 768px) {
    .images {
      grid-template-columns: 1fr;
    }

    .stat-grid {
      grid-template-columns: 1fr;
    }

    .graphs-section {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    header h1 {
      font-size: 2rem;
    }

    .visit-date {
      font-size: 1.5rem;
    }
  }
</style>

{visits.length >= 2 && (
  <>
    <script data-graph-data type="application/json" set:html={JSON.stringify(graphData)}></script>
    <script data-averages type="application/json" set:html={JSON.stringify({ averageRating, averagePrice, minRating })}></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" is:inline></script>
    <script is:inline>
      (function() {
        const graphDataScript = document.querySelector('[data-graph-data]');
        const averagesScript = document.querySelector('[data-averages]');
        if (!graphDataScript || !averagesScript) return;
        
        const graphData = JSON.parse(graphDataScript.textContent || '[]');
        const averages = JSON.parse(averagesScript.textContent || '{}');
        if (graphData.length === 0) return;

        // Wait for Chart.js to load
        function initCharts() {
          if (typeof Chart === 'undefined') {
            setTimeout(initCharts, 100);
            return;
          }

          // Get CSS variable values
          const root = document.documentElement;
          const Pink = getComputedStyle(root).getPropertyValue('--pink').trim();
          const AlabasterExtraDark = getComputedStyle(root).getPropertyValue('--alabaster-extra-dark').trim();
          
          // Convert HSL to RGB for Chart.js (Chart.js needs RGB format)
          // Helper function to convert HSL to RGB
          function hslToRgb(hsl) {
            // Parse HSL string like "hsl(0, 35%, 30%)"
            const match = hsl.match(/(\d+),\s*(\d+)%,\s*(\d+)%/);
            if (!match) return 'rgb(77, 50, 50)'; // fallback
            const h = parseInt(match[1]) / 360;
            const s = parseInt(match[2]) / 100;
            const l = parseInt(match[3]) / 100;
            
            let r, g, b;
            if (s === 0) {
              r = g = b = l;
            } else {
              const hue2rgb = (p, q, t) => {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
              };
              const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
              const p = 2 * l - q;
              r = Math.round(hue2rgb(p, q, h + 1/3) * 255);
              g = Math.round(hue2rgb(p, q, h) * 255);
              b = Math.round(hue2rgb(p, q, h - 1/3) * 255);
            }
            return `rgb(${r}, ${g}, ${b})`;
          }
          
          const borderColor = hslToRgb(Pink);
          const backgroundColor = borderColor.replace('rgb', 'rgba').replace(')', ', 0.1)');
          const averageLineColor = hslToRgb(AlabasterExtraDark);

          const labels = graphData.map(d => d.date);
          const ratingData = graphData.map(d => d.totalRating);
          const priceData = graphData.map(d => d.price);

          // Rating Chart
          const ratingCtx = document.getElementById('ratingChart');
          if (ratingCtx) {
            new Chart(ratingCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Total Rating',
                  data: ratingData,
                  borderColor: borderColor,
                  backgroundColor: backgroundColor,
                  tension: 0.4,
                  fill: true,
                }, {
                  label: 'Average Rating (All Visits)',
                  data: Array(labels.length).fill(averages.averageRating),
                  borderColor: averageLineColor,
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  pointRadius: 0,
                  borderWidth: 2,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: false,
                    min: Math.floor(averages.minRating),
                    max: 25,
                    ticks: {
                      stepSize: 5
                    }
                  }
                }
              }
            });
          }

          // Price Chart
          const priceCtx = document.getElementById('priceChart');
          if (priceCtx) {
            new Chart(priceCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Price ($)',
                  data: priceData,
                  borderColor: borderColor,
                  backgroundColor: backgroundColor,
                  tension: 0.4,
                  fill: true,
                }, {
                  label: 'Average Price (Most Recent per Location)',
                  data: Array(labels.length).fill(averages.averagePrice),
                  borderColor: averageLineColor,
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  pointRadius: 0,
                  borderWidth: 2,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: false,
                    ticks: {
                      callback: function(value) {
                        return '$' + value.toFixed(2);
                      }
                    }
                  }
                }
              }
            });
          }
        }

        // Initialize charts when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCharts);
        } else {
          initCharts();
        }
      })();
    </script>
  </>
)}

