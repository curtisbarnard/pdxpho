---
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';
import locations from '../data/locations.json';
import visits from '../data/visits.json';

function addVisitsToLocation(locations: any[], visits: any[]) {
  for (const location of locations) {
    // Find all visits for this location
    const locationVisits = visits.filter(visit => visit.name === location.name);
    
    if (locationVisits.length > 0) {
      // Sort by date (most recent first) and use the most recent visit
      locationVisits.sort((a, b) => {
        const dateA = new Date(a.dateVisited).getTime();
        const dateB = new Date(b.dateVisited).getTime();
        return dateB - dateA; // Descending order (most recent first)
      });
      location.visits = locationVisits[0];
    }
  }
}

// Remove locations with no visits, then sort first by price and then by total rating
function sortLocations(locations: any[]) {
  const filtered = locations.filter((location) => location.visits);

  filtered.sort((a, b) => {
    return a.visits.price - b.visits.price;
  });

  filtered.sort((a, b) => {
    const aTotal =
      a.visits.herbs + a.visits.aroma + a.visits.flavor + a.visits.noodles + a.visits.meat;
    const bTotal =
      b.visits.herbs + b.visits.aroma + b.visits.flavor + b.visits.noodles + b.visits.meat;
    return bTotal - aTotal;
  });

  return filtered;
}

// TODO need to update this to only use the most recent visit for each location, not all visits
function calculateAveragePrice(visits: any[]) {
  const sum = visits.reduce((acc, curr) => {
    return acc + curr.price;
  }, 0);
  return sum / visits.length;
}

addVisitsToLocation(locations, visits);
const locationsSorted = sortLocations(locations);
const averagePrice = Number(calculateAveragePrice(visits).toFixed(2));
const title = 'PDX Phở';
---

<Layout title={title} />
<main>
  <span>Average Price: ${averagePrice}</span>
  <p>
    Of the {locations.length} places serving Phở in Portland I have visted {locationsSorted.length} of
    them. The below list is sorted with the highest rating at the top. Where the rating is the same I
    have ranked the cheaper bowl higher. Rating values will not be released until I have visited a place
    at least twice.
  </p>
  <ul>
    {
      locationsSorted.map((location) => (
        <li>
          <Card
            locationId={location.id}
            name={location.name}
            link={location.link}
            dateVisited={location.visits.dateVisited}
            price={location.visits.price}
            notes={location.visits.notes}
          />
        </li>
      ))
    }
  </ul>
</main>

<style>
  main {
    padding-top: 1rem;
  }
  ul {
    padding: 0;
  }

  li {
    list-style: none;
    margin: 2rem 0;
  }
</style>
